# Проект разработан в рамаках работы над тестовым заданием ОАО "Белгазпромбанк".

Структура проекта:
1. `/data` - папка с данными для работы с моделью. Файл с данными должен иметь расширение `.xlsx` и называться `data`.
2. `/models` - папка для хранения модельного объекта (изначально пустая).
3. `app.py` - код для создания и запуска сервиса.
4. `constants.py` - константны для работы сервиса.
5. `Dockerfile` - файл для создания `Docker`-образа и деплоя сервиса.
6. `logs` - файл с логами работы приложения.
7. `model_functions.py` - функции для обработки данных, обучения/сохранения модели  и получения предсказаний.
8. `README.md` - описательный файл.
9. `requirements.txt` - файл для установки зависимостей.

Серсис имеет следующие эндпоинты:

1. `/health` - эндпоинт, который проверяет корректность работы сервиса после запуска. В случае корректной работы возвращает соответствующее сообщение.
```python
import requests
url = 'http://127.0.0.1:9119'

response = requests.get(url=f'{url}/health')
response.json()
{'API Status': 'API service for the model is running and working correctly.'}
```
2. `/train_model` - эндпоинт для загрузки данных и обучения модели. В ходе обучения подбираются лучшие гиперпараметры, модель сохраняется в `/models` с названием `model.pkl`. В случае успешного завершения обучения эндпоинт возвращает сообщение со значениями `AUC-ROC` на кросс-валидации и `test` выборке.

```python
import requests
url = 'http://127.0.0.1:9119'
response = requests.get(url=f'{url}/train_model')
response.json()
{'Status': 'The model was trained and saved. AUC-ROC on CV = 0.8164, on test = 0.8665.'}
```
3. `/get_predicts` - эндпоинт для получения предсказаний. На вход принимает `JSON` со значениями соответствующих признаков. Эндпоинт возвращает метку класса и вероятность отнесения к положительному классу. Для корректной работы эндпоинта модель должна быть обучена и размещена в `/models`.

```python
import requests
import json
url = 'http://127.0.0.1:9119'
test_string = """
{'Месяц_создания_заявки': 'autumn',
 'Количество_кредитов_за_последние_3_месяцa': 1,
 'Количество_кредитов_за_последние_6_месяцев': 1,
 'Привлечения_к_административной_ответственности': 9,
 'Привлечения_к_уголовному_судопроизводству': 0,
 'Количество_кредитов': 1,
 'Количество_запросов_за_последние_30_дней': 1,
 'Количество_запросов_всего': 5,
 'Количество_закрытых_кредитов': 1,
 'Количество_закрытых_кредитов_за_последний_год': 1,
 'Количество_просрочек_за_последние_12_месяцев': 0,
 'Продолжительность_последней_просрочки': 0,
 'Общее_количество_договоров_обеспечения': 0,
 'Закрытые_договора_обеспечения': 0,
 'Действующие_договоры_обеспечения': 0,
 'Продолжительность_наибольшей_просрочки_за_последний_год': 0,
 'Продолжительность_наибольшей_просрочки_за_весь_период': 0,
 'Просрочек_основного_долга_от_1_до_7_дней': 0,
 'Просрочек_основного_долга_от_8_до_30_дней': 0,
 'Просрочек_основного_долга_от_31_до_90_дней': 0,
 'Просрочек_основного_долга_от_91_до_180_дней': 0,
 'Просрочек_основного_долга_более_180_дней': 0,
 'Просрочек_процентов_от_1_до_7_дней': 0,
 'Просрочек_процентов_от_8_до_30_дней': 0,
 'Просрочек_процентов_от_31_до_90_дней': 0,
 'Просрочек_процентов_от_91_до_180_дней': 0,
 'Просрочек_процентов_более_180_дней': 0,
 'Просрочек_платежей_от_1_до_7_дней': 0,
 'Просрочек_платежей_от_8_до_30_дней': 0,
 'Просрочек_платежей_от_31_до_90_дней': 0,
 'Просрочек_платежей_от_91_до_180_дней': 0,
 'Просрочек_платежей_более_180_дней': 0,
 'Пол': 'Male',
 'Семейное_положение': 'Married',
 'Количество_детей': 1,
 'В_том_числе_несовершеннолетних_детей': 1,
 'Рабочий_телефон': 'yes',
 'Тип_населенного_пункта_регистрации': 'Village1',
 'Тип_населенного_пункта_проживания': 'Village1',
 'Вид_занятости': 'Recruitment',
 'Образование': 'Secondary special education',
 'Профессия': 'h',
 'Объекты_недвижимости': 'no',
 'Наличие_транспортных_средств': 'yes',
 'Tелефон_отдела_кадров_(второе_место_работы)': 'no',
 'Телефон_бухгалтерии': 'no',
 'Возраст': 27,
 'Рабочий_стаж': 1.0,
 'Кредитная_нагрузка': 0.29310877883186837}
"""
test_string = test_string.replace("'", '"') #замена кавычек на двойные для json.loads
data = json.loads(test_string)
response = requests.post(url=f'{url}/get_predicts', json=data)
response.json()
{'label': '0', 'proba': '0.1241563866236885'}
```
Порядок признаков неважен, но важно соблюдать идентичность названий признаков. В случае отсутствия предобученной модели будет возвращено соответствующее предупреждение:

```python
import requests
import json
url = 'http://127.0.0.1:9119'
test_string = """
{'Месяц_создания_заявки': 'autumn',
 'Количество_кредитов_за_последние_3_месяцa': 1,
 'Количество_кредитов_за_последние_6_месяцев': 1,
 'Привлечения_к_административной_ответственности': 9,
 'Привлечения_к_уголовному_судопроизводству': 0,
 'Количество_кредитов': 1,
 'Количество_запросов_за_последние_30_дней': 1,
 'Количество_запросов_всего': 5,
 'Количество_закрытых_кредитов': 1,
 'Количество_закрытых_кредитов_за_последний_год': 1,
 'Количество_просрочек_за_последние_12_месяцев': 0,
 'Продолжительность_последней_просрочки': 0,
 'Общее_количество_договоров_обеспечения': 0,
 'Закрытые_договора_обеспечения': 0,
 'Действующие_договоры_обеспечения': 0,
 'Продолжительность_наибольшей_просрочки_за_последний_год': 0,
 'Продолжительность_наибольшей_просрочки_за_весь_период': 0,
 'Просрочек_основного_долга_от_1_до_7_дней': 0,
 'Просрочек_основного_долга_от_8_до_30_дней': 0,
 'Просрочек_основного_долга_от_31_до_90_дней': 0,
 'Просрочек_основного_долга_от_91_до_180_дней': 0,
 'Просрочек_основного_долга_более_180_дней': 0,
 'Просрочек_процентов_от_1_до_7_дней': 0,
 'Просрочек_процентов_от_8_до_30_дней': 0,
 'Просрочек_процентов_от_31_до_90_дней': 0,
 'Просрочек_процентов_от_91_до_180_дней': 0,
 'Просрочек_процентов_более_180_дней': 0,
 'Просрочек_платежей_от_1_до_7_дней': 0,
 'Просрочек_платежей_от_8_до_30_дней': 0,
 'Просрочек_платежей_от_31_до_90_дней': 0,
 'Просрочек_платежей_от_91_до_180_дней': 0,
 'Просрочек_платежей_более_180_дней': 0,
 'Пол': 'Male',
 'Семейное_положение': 'Married',
 'Количество_детей': 1,
 'В_том_числе_несовершеннолетних_детей': 1,
 'Рабочий_телефон': 'yes',
 'Тип_населенного_пункта_регистрации': 'Village1',
 'Тип_населенного_пункта_проживания': 'Village1',
 'Вид_занятости': 'Recruitment',
 'Образование': 'Secondary special education',
 'Профессия': 'h',
 'Объекты_недвижимости': 'no',
 'Наличие_транспортных_средств': 'yes',
 'Tелефон_отдела_кадров_(второе_место_работы)': 'no',
 'Телефон_бухгалтерии': 'no',
 'Возраст': 27,
 'Рабочий_стаж': 1.0,
 'Кредитная_нагрузка': 0.29310877883186837}
"""
test_string = test_string.replace("'", '"') #замена кавычек на двойные для json.loads
data = json.loads(test_string)
response = requests.post(url=f'{url}/get_predicts', json=data)
response.json()
{'Warning': "This is the first launch of the application - there aren't any model files in the app directory. You have to run the '/train_model' endpoint first of all to get pre-trained models to use."}
```

Инструкция по запуску:
1. В терминале выполнить команду `https://creds@github.com/AlexGribPython/BGPBTestTask.git` (`creds` будут высланы по электронной почти вместе с заданием) для клонирования репозитория с проектом.
2. В терминале выполнить команду `docker build: docker build -t image_name .` для создания `Docker`-образа.
3. В терминале выполнить команду `docker run -p 9119:9119 image_name` для запуска контейнера.
